<html>
<head>
    <meta charset="" UTF-8"">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
        }
    </style>
    <script>
        function invokeMethod(componentId, methodName, args) {
            try {
                if (!componentId || typeof componentId !== 'string') {
                    throw new Error('Invalid componentId.');
                }
                if (!methodName || typeof methodName !== 'string') {
                    throw new Error('Invalid methodName.');
                }
                let argsStr = '';
                try {
                    argsStr = JSON.stringify(args);
                } catch (e) {
                    throw new Error('Invalid args: ' + e.message);
                }
                window.location.href = `webcomponent://${componentId}/${methodName}?args=${argsStr}`;
            } catch (error) {
                window.location.href = `webcomponent://error/?message=${encodeURIComponent(error.message)}`;
            }
        }

        window.onscroll = function (ev) {
            try {
                if ((window.innerHeight + window.pageYOffset) >= document.body.offsetHeight) {
                    window.location.href = `webcomponent://scroll-bottom`;
                }
            } catch (error) {
                window.location.href = `webcomponent://error/?message=${encodeURIComponent(error.message)}`;
            }
        };

        function updateTextNode(elementId, newText) {
            try {
                if (!elementId || typeof elementId !== 'string') {
                    throw new Error('Invalid elementId.');
                }
                if (typeof newText !== 'string') {
                    throw new Error('Invalid newText.');
                }
                const element = document.getElementById(elementId);

                if (element) {
                    let textNodeFound = false;
                    for (let i = 0; i < element.childNodes.length; i++) {
                        const node = element.childNodes[i];
                        if (node.nodeType === Node.TEXT_NODE) {
                            node.nodeValue = newText;
                            textNodeFound = true;
                            break;
                        }
                    }
                    if (!textNodeFound) {
                        // Add a new text node if none are found
                        const textNode = document.createTextNode(newText);
                        element.appendChild(textNode);
                    }
                } else {
                    throw new Error(`Element with ID "${elementId}" not found.`);
                }
            } catch (error) {
                window.location.href = `webcomponent://error/?message=${encodeURIComponent(error.message)}`;
            }
        }

        function updateElementStyle(elementId, styleKey, value) {
            try {
                if (!elementId || typeof elementId !== 'string') {
                    throw new Error('Invalid elementId.');
                }
                if (!styleKey || typeof styleKey !== 'string') {
                    throw new Error('Invalid styleKey.');
                }
                if (typeof value !== 'string') {
                    throw new Error('Invalid value for style.');
                }

                const element = document.getElementById(elementId);
                if (element) {
                    element.style[styleKey] = value;
                } else {
                    throw new Error(`Element with ID "${elementId}" not found.`);
                }
            } catch (error) {
                window.location.href = `webcomponent://error/?message=${encodeURIComponent(error.message)}`;
            }
        }

        function base64ToUtf8(base64Str) {
            try {
                if (!base64Str || typeof base64Str !== 'string') {
                    throw new Error('Invalid base64Str.');
                }
                // Decode base64 to bytes
                var binaryStr = atob(base64Str);

                // Convert binary string to an array of bytes
                var bytes = new Uint8Array(binaryStr.length);
                for (var i = 0; i < binaryStr.length; i++) {
                    bytes[i] = binaryStr.charCodeAt(i);
                }

                // Decode bytes to a UTF-8 string
                var decodedStr = new TextDecoder('utf-8').decode(bytes);
                return decodedStr;
            } catch (error) {
                window.location.href = `webcomponent://error/?message=${encodeURIComponent('Error decoding base64 string: ' + error.message)}`;
                return null;
            }
        }

        function addElement(base64Html, index, parentid) {
            try {
                if (!base64Html || typeof base64Html !== 'string') {
                    throw new Error('Invalid base64Html.');
                }
                if (typeof index !== 'number' || index < 0) {
                    throw new Error('Invalid index.');
                }

                var container;
                if (parentid) {
                    container = document.getElementById(parentid);
                    if (!container) {
                        throw new Error(`Parent element with ID "${parentid}" not found.`);
                    }
                } else {
                    container = document.body;
                }

                // Save the current scroll position
                var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                // Decode the base64-encoded HTML string using UTF-8
                var decodedHtml = base64ToUtf8(base64Html);
                if (!decodedHtml) {
                    throw new Error('Decoded HTML is empty.');
                }

                var div = document.createElement('div');
                div.innerHTML = decodedHtml;
                var newElement = div.firstChild;
                if (!newElement) {
                    throw new Error('Failed to create new element from decoded HTML.');
                }

                if (index >= container.children.length) {
                    container.appendChild(newElement);
                } else {
                    container.insertBefore(newElement, container.children[index]);
                }

                // Restore the previous scroll position
                window.scrollTo(0, scrollTop);
            } catch (error) {
                window.location.href = `webcomponent://error/?message=${encodeURIComponent(error.message)}`;
            }
        }

        function removeElement(componentId) {
            try {
                if (!componentId || typeof componentId !== 'string') {
                    throw new Error('Invalid componentId.');
                }
                var element = document.getElementById(componentId);
                if (element) {
                    element.parentNode.removeChild(element);
                } else {
                    throw new Error(`Element with ID "${componentId}" not found.`);
                }
            } catch (error) {
                window.location.href = `webcomponent://error/?message=${encodeURIComponent(error.message)}`;
            }
        }

        window.onload = function () {
            try {
                window.location.href = `webcomponent://Loaded`;
            } catch (error) {
                window.location.href = `webcomponent://error/?message=${encodeURIComponent(error.message)}`;
            }
        };

        document.addEventListener('click', (e) => {
            let target = e.target.closest('a');
            if (target) { // if the click was on or within an <a>
                // then based on some condition...
                if (target.getAttribute("href")) {
                    e.preventDefault(); // tell the browser not to respond to the link click
                    // then maybe do something else
                    window.location.href = `webcomponent://href/${encodeURIComponent(error.message)}`;
                }
            }
        });
    </script>
</head>
<body id="body">
</body>
</html>